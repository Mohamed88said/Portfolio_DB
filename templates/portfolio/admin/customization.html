{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Personnalisation du site" %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
.customization-preview {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}

.preview-frame {
    border: 2px solid #dee2e6;
    border-radius: 10px;
    background: white;
    min-height: 400px;
    padding: 20px;
    transition: all 0.3s ease;
}

.color-input-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.color-preview {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    border: 2px solid #dee2e6;
    cursor: pointer;
}

.customization-section {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

body.dark-mode .customization-section {
    background: #2d2d2d;
}

.preset-colors {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
}

.preset-color {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.preset-color:hover,
.preset-color.active {
    border-color: #333;
    transform: scale(1.1);
}

.font-preview {
    padding: 15px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.font-preview:hover,
.font-preview.active {
    border-color: var(--primary);
    background: rgba(var(--primary-rgb), 0.1);
}

.layout-preview {
    width: 100%;
    height: 80px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    background-size: cover;
    background-position: center;
    transition: all 0.3s ease;
}

.layout-preview:hover,
.layout-preview.active {
    border-color: var(--primary);
    transform: scale(1.02);
}

.live-preview {
    transition: all 0.3s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-5 mt-5">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-5">
                    <i class="fas fa-palette text-primary me-3"></i>
                    {% trans "Personnalisation du site" %}
                </h1>
                <div class="admin-actions">
                    <a href="{% url 'portfolio:admin_dashboard' %}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left me-2"></i>{% trans "Retour au tableau de bord" %}
                    </a>
                    <button type="button" class="btn btn-success" id="saveCustomization">
                        <i class="fas fa-save me-2"></i>{% trans "Sauvegarder" %}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Panneau de personnalisation -->
        <div class="col-lg-8">
            <form method="post" enctype="multipart/form-data" id="customizationForm">
                {% csrf_token %}
                
                <!-- Schéma de couleurs -->
                <div class="customization-section">
                    <h4 class="mb-3">
                        <i class="fas fa-palette me-2"></i>{% trans "Couleurs" %}
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form.color_scheme.label }}</label>
                            {{ form.color_scheme }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form.primary_color.label }}</label>
                            <div class="color-input-group">
                                {{ form.primary_color }}
                                <div class="color-preview" id="primaryColorPreview"></div>
                            </div>
                            <div class="preset-colors">
                                <div class="preset-color" style="background: #007bff;" data-color="#007bff"></div>
                                <div class="preset-color" style="background: #28a745;" data-color="#28a745"></div>
                                <div class="preset-color" style="background: #dc3545;" data-color="#dc3545"></div>
                                <div class="preset-color" style="background: #ffc107;" data-color="#ffc107"></div>
                                <div class="preset-color" style="background: #6f42c1;" data-color="#6f42c1"></div>
                                <div class="preset-color" style="background: #fd7e14;" data-color="#fd7e14"></div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form.secondary_color.label }}</label>
                            <div class="color-input-group">
                                {{ form.secondary_color }}
                                <div class="color-preview" id="secondaryColorPreview"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">{{ form.accent_color.label }}</label>
                            <div class="color-input-group">
                                {{ form.accent_color }}
                                <div class="color-preview" id="accentColorPreview"></div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">{{ form.background_color.label }}</label>
                            <div class="color-input-group">
                                {{ form.background_color }}
                                <div class="color-preview" id="backgroundColorPreview"></div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">{{ form.text_color.label }}</label>
                            <div class="color-input-group">
                                {{ form.text_color }}
                                <div class="color-preview" id="textColorPreview"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Typographie -->
                <div class="customization-section">
                    <h4 class="mb-3">
                        <i class="fas fa-font me-2"></i>{% trans "Typographie" %}
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form.font_family.label }}</label>
                            {{ form.font_family }}
                            <div class="font-previews mt-2">
                                <div class="font-preview" data-font="inter" style="font-family: Inter, sans-serif;">
                                    Inter - The quick brown fox jumps over the lazy dog
                                </div>
                                <div class="font-preview" data-font="roboto" style="font-family: Roboto, sans-serif;">
                                    Roboto - The quick brown fox jumps over the lazy dog
                                </div>
                                <div class="font-preview" data-font="montserrat" style="font-family: Montserrat, sans-serif;">
                                    Montserrat - The quick brown fox jumps over the lazy dog
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label">{{ form.heading_font_size.label }}</label>
                                    {{ form.heading_font_size }}
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label">{{ form.body_font_size.label }}</label>
                                    {{ form.body_font_size }}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">{{ form.line_height.label }}</label>
                                {{ form.line_height }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mise en page -->
                <div class="customization-section">
                    <h4 class="mb-3">
                        <i class="fas fa-layout me-2"></i>{% trans "Mise en page" %}
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form.layout_style.label }}</label>
                            {{ form.layout_style }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form.header_style.label }}</label>
                            {{ form.header_style }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">{{ form.container_width.label }}</label>
                            {{ form.container_width }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">{{ form.border_radius.label }}</label>
                            {{ form.border_radius }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">{{ form.spacing_unit.label }}</label>
                            {{ form.spacing_unit }}
                        </div>
                    </div>
                </div>

                <!-- En-tête et logo -->
                <div class="customization-section">
                    <h4 class="mb-3">
                        <i class="fas fa-image me-2"></i>{% trans "En-tête et logo" %}
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch">
                                {{ form.show_logo }}
                                <label class="form-check-label" for="{{ form.show_logo.id_for_label }}">
                                    {{ form.show_logo.label }}
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form.logo_image.label }}</label>
                            {{ form.logo_image }}
                        </div>
                    </div>
                </div>

                <!-- Pied de page -->
                <div class="customization-section">
                    <h4 class="mb-3">
                        <i class="fas fa-align-center me-2"></i>{% trans "Pied de page" %}
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">{{ form.footer_text.label }}</label>
                            {{ form.footer_text }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check form-switch">
                                {{ form.show_social_links }}
                                <label class="form-check-label" for="{{ form.show_social_links.id_for_label }}">
                                    {{ form.show_social_links.label }}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CSS et JS personnalisés -->
                <div class="customization-section">
                    <h4 class="mb-3">
                        <i class="fas fa-code me-2"></i>{% trans "Code personnalisé" %}
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form.custom_css.label }}</label>
                            {{ form.custom_css }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form.custom_js.label }}</label>
                            {{ form.custom_js }}
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Prévisualisation -->
        <div class="col-lg-4">
            <div class="customization-preview">
                <h5 class="mb-3">
                    <i class="fas fa-eye me-2"></i>{% trans "Aperçu en temps réel" %}
                </h5>
                
                <div class="preview-frame live-preview" id="livePreview">
                    <div class="preview-header" style="background: var(--primary-color, #007bff); color: white; padding: 15px; margin: -20px -20px 20px -20px; border-radius: 8px 8px 0 0;">
                        <h6 class="mb-0">{% trans "Aperçu du site" %}</h6>
                    </div>
                    
                    <div class="preview-content">
                        <h2 class="preview-heading">{% trans "Titre principal" %}</h2>
                        <p class="preview-text">{% trans "Ceci est un exemple de texte pour prévisualiser les changements de style. Vous pouvez voir comment vos modifications affectent l'apparence du site." %}</p>
                        
                        <div class="preview-buttons mt-3">
                            <button class="btn btn-primary me-2">{% trans "Bouton principal" %}</button>
                            <button class="btn btn-outline-secondary">{% trans "Bouton secondaire" %}</button>
                        </div>
                        
                        <div class="preview-card mt-3" style="border: 1px solid #dee2e6; border-radius: var(--border-radius, 8px); padding: 15px;">
                            <h5>{% trans "Carte d'exemple" %}</h5>
                            <p class="text-muted">{% trans "Contenu de la carte avec du texte d'exemple." %}</p>
                        </div>
                    </div>
                </div>
                
                <div class="preview-actions mt-3">
                    <button type="button" class="btn btn-outline-primary w-100" id="previewChanges">
                        <i class="fas fa-sync me-2"></i>{% trans "Actualiser l'aperçu" %}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('customizationForm');
    const livePreview = document.getElementById('livePreview');
    const previewButton = document.getElementById('previewChanges');
    const saveButton = document.getElementById('saveCustomization');
    
    // Initialiser les aperçus de couleur
    function initColorPreviews() {
        const colorInputs = ['primary_color', 'secondary_color', 'accent_color', 'background_color', 'text_color'];
        colorInputs.forEach(inputName => {
            const input = document.getElementById(`id_${inputName}`);
            const preview = document.getElementById(`${inputName.replace('_', '')}Preview`);
            if (input && preview) {
                preview.style.backgroundColor = input.value;
                input.addEventListener('change', function() {
                    preview.style.backgroundColor = this.value;
                    updateLivePreview();
                });
            }
        });
    }
    
    // Gérer les couleurs prédéfinies
    document.querySelectorAll('.preset-color').forEach(preset => {
        preset.addEventListener('click', function() {
            const color = this.dataset.color;
            const primaryInput = document.getElementById('id_primary_color');
            const primaryPreview = document.getElementById('primaryColorPreview');
            
            primaryInput.value = color;
            primaryPreview.style.backgroundColor = color;
            updateLivePreview();
        });
    });
    
    // Gérer les aperçus de police
    document.querySelectorAll('.font-preview').forEach(preview => {
        preview.addEventListener('click', function() {
            const font = this.dataset.font;
            const fontSelect = document.getElementById('id_font_family');
            
            // Retirer la classe active des autres
            document.querySelectorAll('.font-preview').forEach(p => p.classList.remove('active'));
            this.classList.add('active');
            
            fontSelect.value = font;
            updateLivePreview();
        });
    });
    
    // Mettre à jour l'aperçu en temps réel
    function updateLivePreview() {
        const formData = new FormData(form);
        const data = {};
        
        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }
        
        // Appliquer les styles à l'aperçu
        const root = livePreview.style;
        root.setProperty('--primary-color', data.primary_color || '#007bff');
        root.setProperty('--secondary-color', data.secondary_color || '#6c757d');
        root.setProperty('--accent-color', data.accent_color || '#28a745');
        root.setProperty('--background-color', data.background_color || '#ffffff');
        root.setProperty('--text-color', data.text_color || '#333333');
        root.setProperty('--border-radius', (data.border_radius || 8) + 'px');
        
        livePreview.style.fontFamily = (data.font_family || 'inter') + ', sans-serif';
        livePreview.style.fontSize = (data.body_font_size || 16) + 'px';
        livePreview.style.lineHeight = data.line_height || '1.6';
        livePreview.style.backgroundColor = data.background_color || '#ffffff';
        livePreview.style.color = data.text_color || '#333333';
        
        // Mettre à jour les éléments spécifiques
        const previewHeader = livePreview.querySelector('.preview-header');
        if (previewHeader) {
            previewHeader.style.backgroundColor = data.primary_color || '#007bff';
        }
        
        const previewHeading = livePreview.querySelector('.preview-heading');
        if (previewHeading) {
            previewHeading.style.fontSize = (data.heading_font_size || 32) + 'px';
        }
        
        const primaryBtn = livePreview.querySelector('.btn-primary');
        if (primaryBtn) {
            primaryBtn.style.backgroundColor = data.primary_color || '#007bff';
            primaryBtn.style.borderColor = data.primary_color || '#007bff';
            primaryBtn.style.borderRadius = (data.border_radius || 8) + 'px';
        }
        
        const secondaryBtn = livePreview.querySelector('.btn-outline-secondary');
        if (secondaryBtn) {
            secondaryBtn.style.borderColor = data.secondary_color || '#6c757d';
            secondaryBtn.style.color = data.secondary_color || '#6c757d';
            secondaryBtn.style.borderRadius = (data.border_radius || 8) + 'px';
        }
        
        const previewCard = livePreview.querySelector('.preview-card');
        if (previewCard) {
            previewCard.style.borderRadius = (data.border_radius || 8) + 'px';
        }
    }
    
    // Écouter les changements sur tous les inputs
    form.addEventListener('change', updateLivePreview);
    form.addEventListener('input', updateLivePreview);
    
    // Bouton d'actualisation de l'aperçu
    previewButton.addEventListener('click', updateLivePreview);
    
    // Bouton de sauvegarde
    saveButton.addEventListener('click', function() {
        form.submit();
    });
    
    // Initialiser
    initColorPreviews();
    updateLivePreview();
    
    // Afficher un message de confirmation avant de quitter si des modifications non sauvegardées
    let formChanged = false;
    form.addEventListener('change', () => formChanged = true);
    
    window.addEventListener('beforeunload', function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
    
    form.addEventListener('submit', () => formChanged = false);
});
</script>
{% endblock %}