{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}
    {% if query %}
        {% blocktrans %}Résultats pour "{{ query }}"{% endblocktrans %} - {{ block.super }}
    {% else %}
        {% trans "Recherche" %} - {{ block.super }}
    {% endif %}
{% endblock %}

{% block content %}
<div class="container py-5 mt-5">
    <!-- En-tête de recherche -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="search-header text-center mb-4">
                <h1 class="display-5 mb-3">
                    <i class="fas fa-search text-primary me-3"></i>
                    {% if query %}
                        {% blocktrans %}Résultats pour "{{ query }}"{% endblocktrans %}
                    {% else %}
                        {% trans "Recherche Universelle" %}
                    {% endif %}
                </h1>
                {% if total_results > 0 %}
                    <p class="lead text-muted">{{ total_results }} résultat{{ total_results|pluralize }} trouvé{{ total_results|pluralize }}</p>
                {% endif %}
            </div>
            
            <!-- Formulaire de recherche avancée -->
            <div class="search-form-container">
                <form method="get" class="search-form">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-6">
                            <div class="search-input-group">
                                <input type="text" name="q" class="form-control form-control-lg" 
                                       value="{{ query }}" placeholder="{% trans 'Rechercher dans tout le portfolio...' %}"
                                       id="universalSearchInput" autocomplete="off">
                                <div class="search-suggestions" id="searchSuggestions"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select name="category" class="form-select form-select-lg">
                                <option value="all" {% if category == 'all' %}selected{% endif %}>{% trans "Toutes les catégories" %}</option>
                                <option value="projects" {% if category == 'projects' %}selected{% endif %}>{% trans "Projets" %}</option>
                                <option value="experiences" {% if category == 'experiences' %}selected{% endif %}>{% trans "Expériences" %}</option>
                                <option value="skills" {% if category == 'skills' %}selected{% endif %}>{% trans "Compétences" %}</option>
                                <option value="blog" {% if category == 'blog' %}selected{% endif %}>{% trans "Blog" %}</option>
                                <option value="certifications" {% if category == 'certifications' %}selected{% endif %}>{% trans "Certifications" %}</option>
                                <option value="testimonials" {% if category == 'testimonials' %}selected{% endif %}>{% trans "Témoignages" %}</option>
                                <option value="faq" {% if category == 'faq' %}selected{% endif %}>{% trans "FAQ" %}</option>
                                <option value="resources" {% if category == 'resources' %}selected{% endif %}>{% trans "Ressources" %}</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-search me-2"></i>{% trans "Rechercher" %}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if not query %}
        <!-- Page d'accueil de recherche -->
        <div class="search-home">
            <!-- Suggestions populaires -->
            {% if popular_searches %}
            <div class="row mb-5">
                <div class="col-12">
                    <h3 class="mb-4">{% trans "Recherches populaires" %}</h3>
                    <div class="popular-searches">
                        {% for search in popular_searches %}
                            <a href="?q={{ search.query }}" class="badge bg-light text-dark me-2 mb-2 popular-search-tag">
                                {{ search.query }} <span class="badge bg-primary ms-1">{{ search.count }}</span>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Nuage de tags -->
            <div class="row mb-5">
                <div class="col-12">
                    <h3 class="mb-4">{% trans "Explorer par sujets" %}</h3>
                    <div class="tag-cloud" id="tagCloud">
                        <!-- Chargé dynamiquement via JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Catégories de recherche -->
            <div class="row">
                <div class="col-12">
                    <h3 class="mb-4">{% trans "Rechercher par catégorie" %}</h3>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <a href="?category=projects" class="search-category-card">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <i class="fas fa-project-diagram fa-3x text-primary mb-3"></i>
                                        <h5>{% trans "Projets" %}</h5>
                                        <p class="text-muted">{% trans "Applications, sites web, solutions techniques" %}</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="?category=experiences" class="search-category-card">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <i class="fas fa-briefcase fa-3x text-success mb-3"></i>
                                        <h5>{% trans "Expériences" %}</h5>
                                        <p class="text-muted">{% trans "Parcours professionnel, postes occupés" %}</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="?category=blog" class="search-category-card">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <i class="fas fa-blog fa-3x text-info mb-3"></i>
                                        <h5>{% trans "Articles" %}</h5>
                                        <p class="text-muted">{% trans "Blog, tutoriels, réflexions" %}</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="?category=skills" class="search-category-card">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <i class="fas fa-cogs fa-3x text-warning mb-3"></i>
                                        <h5>{% trans "Compétences" %}</h5>
                                        <p class="text-muted">{% trans "Technologies, outils, savoir-faire" %}</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Résultats de recherche -->
        {% if total_results > 0 %}
            <!-- Filtres de résultats -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="results-filters">
                        <div class="d-flex flex-wrap gap-2">
                            {% for category_name, category_results in results.items %}
                                {% if category_results %}
                                    <a href="#{{ category_name }}" class="btn btn-outline-primary btn-sm">
                                        {% if category_name == 'projects' %}{% trans "Projets" %}
                                        {% elif category_name == 'experiences' %}{% trans "Expériences" %}
                                        {% elif category_name == 'skills' %}{% trans "Compétences" %}
                                        {% elif category_name == 'blog' %}{% trans "Articles" %}
                                        {% elif category_name == 'certifications' %}{% trans "Certifications" %}
                                        {% elif category_name == 'testimonials' %}{% trans "Témoignages" %}
                                        {% elif category_name == 'faq' %}{% trans "FAQ" %}
                                        {% elif category_name == 'resources' %}{% trans "Ressources" %}
                                        {% endif %}
                                        <span class="badge bg-primary ms-1">{{ category_results|length }}</span>
                                    </a>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Résultats par catégorie -->
            {% for category_name, category_results in results.items %}
                {% if category_results %}
                    <div class="results-section mb-5" id="{{ category_name }}">
                        <h3 class="mb-4">
                            {% if category_name == 'projects' %}
                                <i class="fas fa-project-diagram text-primary me-2"></i>{% trans "Projets" %}
                            {% elif category_name == 'experiences' %}
                                <i class="fas fa-briefcase text-success me-2"></i>{% trans "Expériences" %}
                            {% elif category_name == 'skills' %}
                                <i class="fas fa-cogs text-warning me-2"></i>{% trans "Compétences" %}
                            {% elif category_name == 'blog' %}
                                <i class="fas fa-blog text-info me-2"></i>{% trans "Articles" %}
                            {% elif category_name == 'certifications' %}
                                <i class="fas fa-certificate text-danger me-2"></i>{% trans "Certifications" %}
                            {% elif category_name == 'testimonials' %}
                                <i class="fas fa-quote-left text-secondary me-2"></i>{% trans "Témoignages" %}
                            {% elif category_name == 'faq' %}
                                <i class="fas fa-question-circle text-primary me-2"></i>{% trans "FAQ" %}
                            {% elif category_name == 'resources' %}
                                <i class="fas fa-download text-success me-2"></i>{% trans "Ressources" %}
                            {% endif %}
                            <span class="badge bg-light text-dark">{{ category_results|length }}</span>
                        </h3>
                        
                        <div class="row">
                            {% for result in category_results %}
                                <div class="col-lg-6 mb-4">
                                    <div class="search-result-card">
                                        <div class="card h-100">
                                            {% if result.image %}
                                                <img src="{{ result.image }}" class="card-img-top search-result-image" alt="{{ result.title }}">
                                            {% endif %}
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <span class="badge bg-primary">{{ result.type }}</span>
                                                    {% if result.date %}
                                                        <small class="text-muted">{{ result.date|date:"M Y" }}</small>
                                                    {% endif %}
                                                </div>
                                                <h5 class="card-title">
                                                    <a href="{{ result.url }}" class="text-decoration-none">{{ result.title }}</a>
                                                </h5>
                                                <p class="card-text">{{ result.description|truncatewords:25 }}</p>
                                                {% if result.tags %}
                                                    <div class="result-tags">
                                                        {% for tag in result.tags %}
                                                            {% if tag %}
                                                                <span class="badge bg-light text-dark me-1">{{ tag|trim }}</span>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="card-footer bg-transparent">
                                                <a href="{{ result.url }}" class="btn btn-outline-primary btn-sm">
                                                    {% trans "Voir plus" %} <i class="fas fa-arrow-right ms-1"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <!-- Aucun résultat -->
            <div class="no-results text-center py-5">
                <i class="fas fa-search fa-5x text-muted mb-4"></i>
                <h3 class="text-muted mb-3">{% trans "Aucun résultat trouvé" %}</h3>
                <p class="lead text-muted mb-4">
                    {% blocktrans %}Aucun contenu ne correspond à votre recherche "{{ query }}"{% endblocktrans %}
                </p>
                
                <!-- Suggestions -->
                {% if suggestions %}
                    <div class="search-suggestions-box">
                        <h5>{% trans "Essayez plutôt :" %}</h5>
                        <div class="d-flex flex-wrap justify-content-center gap-2">
                            {% for suggestion in suggestions %}
                                <a href="?q={{ suggestion }}" class="badge bg-primary text-decoration-none">{{ suggestion }}</a>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                
                <div class="mt-4">
                    <a href="{% url 'portfolio:universal_search' %}" class="btn btn-primary">
                        {% trans "Nouvelle recherche" %}
                    </a>
                </div>
            </div>
        {% endif %}
    {% endif %}
</div>

<style>
.search-input-group {
    position: relative;
}

.search-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #dee2e6;
    border-top: none;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    z-index: 1000;
    display: none;
}

.search-suggestion-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #f8f9fa;
}

.search-suggestion-item:hover {
    background: #f8f9fa;
}

.search-suggestion-item:last-child {
    border-bottom: none;
}

.popular-search-tag {
    font-size: 0.9rem;
    padding: 8px 12px;
    text-decoration: none;
    transition: all 0.3s ease;
}

.popular-search-tag:hover {
    background: var(--primary) !important;
    color: white !important;
    transform: translateY(-2px);
}

.tag-cloud {
    text-align: center;
    padding: 20px;
}

.tag-cloud-item {
    display: inline-block;
    margin: 5px;
    padding: 8px 16px;
    border-radius: 20px;
    text-decoration: none;
    transition: all 0.3s ease;
    font-weight: 500;
}

.tag-cloud-item:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.search-category-card {
    text-decoration: none;
    color: inherit;
}

.search-category-card:hover {
    color: inherit;
    text-decoration: none;
}

.search-category-card .card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.search-category-card:hover .card {
    transform: translateY(-5px);
    border-color: var(--primary);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}

.search-result-card .card {
    transition: all 0.3s ease;
}

.search-result-card:hover .card {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

.search-result-image {
    height: 200px;
    object-fit: cover;
}

.result-tags {
    margin-top: 10px;
}

.results-filters {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.search-suggestions-box {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin: 20px 0;
}

body.dark-mode .search-suggestions {
    background: #2d2d2d;
    border-color: #404040;
}

body.dark-mode .search-suggestion-item:hover {
    background: #404040;
}

body.dark-mode .results-filters,
body.dark-mode .search-suggestions-box {
    background: #2d2d2d;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('universalSearchInput');
    const suggestionsContainer = document.getElementById('searchSuggestions');
    let searchTimeout;

    // Autocomplétion de recherche
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            suggestionsContainer.style.display = 'none';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`/api/search-suggestions/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    displaySuggestions(data.suggestions);
                })
                .catch(error => console.error('Erreur suggestions:', error));
        }, 300);
    });

    function displaySuggestions(suggestions) {
        if (suggestions.length === 0) {
            suggestionsContainer.style.display = 'none';
            return;
        }

        suggestionsContainer.innerHTML = suggestions.map(suggestion => 
            `<div class="search-suggestion-item" onclick="selectSuggestion('${suggestion}')">${suggestion}</div>`
        ).join('');
        
        suggestionsContainer.style.display = 'block';
    }

    window.selectSuggestion = function(suggestion) {
        searchInput.value = suggestion;
        suggestionsContainer.style.display = 'none';
        searchInput.form.submit();
    };

    // Masquer les suggestions en cliquant ailleurs
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
            suggestionsContainer.style.display = 'none';
        }
    });

    // Charger le nuage de tags
    const tagCloud = document.getElementById('tagCloud');
    if (tagCloud) {
        fetch('/api/tag-cloud/')
            .then(response => response.json())
            .then(data => {
                displayTagCloud(data.tags);
            })
            .catch(error => console.error('Erreur tag cloud:', error));
    }

    function displayTagCloud(tags) {
        const maxCount = Math.max(...tags.map(tag => tag.count));
        
        tagCloud.innerHTML = tags.map(tag => {
            const size = Math.max(0.8, (tag.count / maxCount) * 2);
            return `<a href="${tag.url}" class="tag-cloud-item" 
                       style="background-color: ${tag.color}; color: white; font-size: ${size}rem;">
                       ${tag.name} <span style="opacity: 0.8;">(${tag.count})</span>
                    </a>`;
        }).join('');
    }

    // Smooth scroll pour les ancres
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});
</script>
{% endblock %}